<include  file='public:header'/>
<style>
.profit {text-align: center;color: #333;font-weight: bold; background: #F5F5FB;}
.lfTdBt{width:200px;}
#poster {
    width: 320px;
    height: 504px;
    border: 1px solid #ccc;
    position: relative;
}
#poster .bg {
    position: absolute;
    width: 100%;
    z-index: 0;
}

#poster .drag {
    position: absolute;
    width: 80px;
    height: 80px;
    border: 1px solid #000;
}
.form-horizontal .form-group {
    margin-right: -15px;
    margin-left: -15px;
}
bootstrap.min.css?v=3.3.7:5
.form-group {
    margin-bottom: 15px;
}
.col-lg.control-label, .col-lger.control-label {
    color: #000;
    font-weight: normal;
}
.input-group .form-control {
    position: relative;
    z-index: 2;
    float: left;
    width: 100%;
    margin-bottom: 0;
}
.form-control {
    background-color: #FFFFFF;
    background-image: none;
    border: 1px solid #efefef;
    border-radius: 1px;
    color: inherit;
    display: block;
    -webkit-transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
    transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
    width: 100%;
    font-size: 12px;
    height: 32px;
}

.input-group {
    position: relative;
    display: table;
    border-collapse: separate;
}

 .input-group-btn {
    width: 1%;
    white-space: nowrap;
    vertical-align: middle;
}

.col-lg.control-label, .col-lger.control-label {
    color: #000;
    font-weight: normal;
}
 
.form-horizontal .control-label {
    padding-top: 7px;
    margin-bottom: 0;
    text-align: right;
} 
.col-lg {
    float: left;
    padding-right: 10px;
    padding-left: 10px;
    position: relative;
    width: 140px;
}
.input-group {
    position: relative;
    display: table;
    border-collapse: separate;
}


.input-group-btn {
    position: relative;
    font-size: 0;
    white-space: nowrap;
}
.input-group-addon, .input-group-btn {
    width: 1%;
    white-space: nowrap;
    vertical-align: middle;
}
 
.input-group .form-control, .input-group-addon, .input-group-btn {
    display: table-cell;
}
.btn-primary {
    background: #44abf7 !important;
    border-color: #44abf7 !important;
    color: #fff !important;
}
.img-thumbnail {
    border-radius: 0 !important;
} 
.img-thumbnail {
    display: inline-block;
    max-width: 100%;
    height: auto;
    padding: 4px;
    line-height: 1.42857143;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    -webkit-transition: all .2s ease-in-out;
    -o-transition: all .2s ease-in-out;
    transition: all .2s ease-in-out;
}
 .close {
    float: right;
    font-size: 21px;
    font-weight: 700;
    line-height: 1;
    color: #000;
    text-shadow: 0 1px 0 #fff;
    filter: alpha(opacity=20);
    opacity: .2;
}
 
.tableBox em {
    background: #fff;
    padding-left: 20px;
    color: #333;
    line-height: 26px;
}

em, i {
    font-style: normal;

.help-block {
    color: #999;
} 
.help-block {
    display: block;
    margin-top: 5px;
    margin-bottom: 10px;
    color: #737373;
}



</style>

<script language='javascript' src="/static/default/webuploader/designer.js"></script>
<script language='javascript' src="/static/default/webuploader/require.js"></script>
<!-- <script language='javascript' src="/static/default/webuploader/util.js"></script> -->
<!-- <script language='javascript' src="/static/default/webuploader/utill.js"></script> -->
<style type='text/css'>
    #poster {
        width:320px;height:504px;border:1px solid #ccc;position:relative
    }
   #poster .bg { position:absolute;width:100%;z-index:0}
   #poster .drag[type=img] img,#poster .drag[type=thumb] img { width:100%;height:100%; }
    
   #poster .drag { position: absolute; width:80px;height:80px; border:1px solid #000; }
    
    
    #poster .drag[type=nickname] { width:80px;height:40px; font-size:16px; font-family: 黑体;}
    #poster .drag img {position:absolute;z-index:0;width:100%; }
    
    #poster .rRightDown,.rLeftDown,.rLeftUp,.rRightUp,.rRight,.rLeft,.rUp,.rDown{
            position:absolute;
            width:7px;
            height:7px;
            z-index:1;
            font-size:0;
    }    
 
     
       #poster .rRightDown,.rLeftDown,.rLeftUp,.rRightUp,.rRight,.rLeft,.rUp,.rDown{
              background:#C00;
       }
        .rLeftDown,.rRightUp{cursor:ne-resize;}
    .rRightDown,.rLeftUp{cursor:nw-resize;}
    .rRight,.rLeft{cursor:e-resize;}
    .rUp,.rDown{cursor:n-resize;}
    .rLeftDown{left:-4px;bottom:-4px;}
    .rRightUp{right:-4px;top:-4px;}
    .rRightDown{right:-4px;bottom:-4px;}
        
            .rRightDown{background-color:#00F;}   
           
    .rLeftUp{left:-4px;top:-4px;}
    .rRight{right:-4px;top:50%;margin-top:-4px;}
    .rLeft{left:-4px;top:50%;margin-top:-4px;}
    .rUp{top:-4px;left:50%;margin-left:-4px;}
    .rDown{bottom:-4px;left:50%;margin-left:-4px;}
    .context-menu-layer { z-index:9999;}
    .context-menu-list { z-index:9999;}

</style>



<div class="mainBt">
    <ul>
        <li class="li1">设置</li>
        <li class="li2">基本设置</li>
        <li class="li2 li3">海报设置</li>
    </ul>
</div>
<p class="attention">注意：<span>注意：这里是海报相关配置</span></p>
<form  target="x-frame" action="<{:U('setting/poster')}>" method="post">
    <div class="mainScAdd">
        <div class="tableBox"><table style="width:100%;">
            <tbody><tr>
                <td style="width:320px;padding:10px;" valign="top">
                    <div id="poster">
                        <img src="" class="bg" id="bg">
                         <div class="drag" type="qr" index="1" style="<{$tans}>; position: absolute;" src="" size="" color="">
                            <img src="/themes/default/Admin/statics/images/qr.jpg">
                            <div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div>
                         </div>
                        <div class="drag" type="head" index="1" style="<{$head}>; position: absolute;" src="" size="" color="">
                            <img src="/themes/default/Admin/statics/images/head.jpg">
                            <div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div>
                        </div>
                        <div class="drag" type="nickname" index="1" style="<{$nickname}>; position: absolute;" src="" size="" color="">
                            <div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div>
                        </div>
                        
                    </div>
                </td>
                <td valign="top" style="padding:10px;">
                                        <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="form-group" id="bgset">
                                <label class="col-lg control-label">背景图片</label>
                                <div class="col-sm-9 col-xs-12">
                                    
		<script type="text/javascript">
			function showImageDialog(elm, opts, options) {
                console.log(elm);
                console.log(options);
                console.log(opts);
				require(["util"], function(util){
					var btn = $(elm);
					var ipt = btn.parent().prev();
					var val = ipt.val();
					var img = ipt.parent().next().children();
					options = {'global':false,'class_extra':'','direct':true,'multiple':false,'fileSizeLimit':0};
					util.image(val, function(url){
						if(url.url){
							if(img.length > 0){
								img.get(0).src = url.url;
								img.closest(".input-group").show();
							}
							ipt.val(url.attachment);
							ipt.attr("filename",url.filename);
							ipt.attr("url",url.url);
						}
						if(url.media_id){
							if(img.length > 0){
								img.get(0).src = "";
							}
							ipt.val(url.media_id);
						}
					}, options);
				});
			}
			function deleteImage(elm){
				require(["jquery"], function($){
					$(elm).prev().attr("src", "../addons/ewei_shopv2/static/images/default-pic.jpg");
					$(elm).parent().prev().find("input").val("");
				});
			}
		</script>

		<div class="input-group ">
			<input type="text" name="bg" id="data_face" class="form-control" autocomplete="off">
			<span class="input-group-btn">
				<!-- <button class="btn btn-primary" type="button" id="fileToUpload" onclick="images();"><div id="fileToUpload">选择图片</div></button> -->
                 <div style="width: 300px;height: 100px; float: left;">
                        <input type="hidden" name="data[face]" value="<{$detail.face}>" id="data_face" />
                        <div id="fileToUpload" >上传图片</div>
                    </div>/
                    <script>                                            
                        var width_user = '<{:thumbSize($CONFIG[attachs][user][thumb],0)}>';                         
                        var height_user = '<{:thumbSize($CONFIG[attachs][user][thumb],1)}>';                     
                        var uploader = WebUploader.create({                             
                        auto: true,                             
                        swf: '/static/default/webuploader/Uploader.swf',                             
                        server: '<{:U("app/upload/uploadify",array("model"=>"goods"))}>',                             
                        pick: '#fileToUpload',                             
                        resize: true,  
                        compress : {width: width_user,height: height_user,quality: 80,allowMagnify: false,crop: true}                       
                    });                                                 
                    uploader.on( 'uploadSuccess', function( file,resporse) {    
                        console.log(resporse);                        
                        $("#data_face").val(resporse.url);                             
                        $("#face_img").attr('src',resporse.url).show();
                        $("#bg").attr('src',resporse.url).show();                  
                    });                                                
                    uploader.on( 'uploadError', function( file ) {                             
                        alert('上传出错');                         
                    });                     
                    </script>
                <!-- <button class="btn btn-primary" type="button" id="fileToUpload" onclick="imagesAAAAA(this);">选择图片</button> -->
			</span>
		</div>
        <div class="input-group " style="margin-top:.5em;">
            <!-- <img src="http://rrshop.cn/attachment/images/1/2018/06/nS3Fv3VKf3Fih3f3HK05m9L49kis3u.png" onerror="this.src='/themes/default/Admin/statics/images/nopic.jpg'; this.title='图片未找到.'" class="img-responsive img-thumbnail" width="150"> -->
            <img src="" id="face_img" onerror="this.src='/themes/default/Admin/statics/images/nopic.jpg'; this.title='图片未找到.'" class="img-responsive img-thumbnail" width="150">
                <em class="close" style="position:absolute; top: 0px; right: -14px;" title="删除这张图片" onclick="deleteImage(this)">×</em>
            </div>                                    <span class="help-block">背景图片尺寸: 640 * 1008</span>
                                </div>


                            </div>
                         
                            <div id="qrset" style="display:none">
                                <div class="form-group">
                                    <label class="col-lg control-label">二维码尺寸</label>
                                    <div class="col-sm-9 col-xs-12">
                                        <select id="qrsize" class="form-control">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                        </select>
                                    </div>

                                </div>
                            </div>

                            <div id="nameset" style="display:none">
                                <div class="form-group">
                                    <label class="col-lg control-label">昵称颜色</label>
                                    <div class="col-sm-9 col-xs-12">
                                        
		<script type="text/javascript">
			$(function(){
			/*
				$(".colorpicker").each(function(){
					var elm = this;
					util.colorpicker(elm, function(color){
						$(elm).parent().prev().prev().val(color.toHexString());
						$(elm).parent().prev().css("background-color", color.toHexString());
					});
				});
				$(".colorclean").click(function(){
					$(this).parent().prev().prev().val("");
					$(this).parent().prev().css("background-color", "#FFF");
				});
				*/
			});
		</script>
		<div class="row row-fix">
			<div class="col-xs-8 col-sm-8" style="padding-right:0;">
				<div class="input-group">
					<input class="form-control" type="text" name="color" placeholder="请选择颜色" value="">
					<span class="input-group-addon" style="width:35px;border-left:none;background-color:"></span>
					<span class="input-group-btn">
						<button class="btn btn-default colorpicker" type="button">选择颜色 <i class="fa fa-caret-down"></i></button>
						<button class="btn btn-default colorclean" type="button"><span><i class="fa fa-remove"></i></span></button>
					</span>
				</div>
			</div>
		</div>
		                                    </div>

                                </div>
                                <div class="form-group">
                                    <label class="col-lg control-label">昵称大小</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" id="namesize" class="form-control namesize" placeholder="例如: 14,16">
                                            <div class="input-group-addon">px</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" id="imgset" style="display:none">
                                <label class="col-lg control-label">图片设置</label>
                                <div class="col-sm-9 col-xs-12">
                                    
		<div class="input-group ">
			<input type="text" name="img" value="" class="form-control" autocomplete="off">
			<span class="input-group-btn">
				<button class="btn btn-primary" type="button" onclick="showImageDialog(this);">选择图片</button>
			</span>
		</div>
		
		
		<div class="input-group " style="margin-top:.5em;"><img src="/themes/default/Admin/statics/images/default-pic.jpg" onerror="this.src='/themes/default/Admin/statics/images/nopic.jpg'; this.title='图片未找到.'" class="img-responsive img-thumbnail" width="150">
                <em class="close" style="position:absolute; top: 0px; right: -14px;" title="删除这张图片" onclick="deleteImage(this)">×</em>
            </div>          







			</div>
                            </div>



<div class="form-group">
                                <label class="col-lg control-label">海报元素</label>
                                <div class="col-sm-9 col-xs-12">
                                    <button class="btn btn-default btn-com" type="button" data-type="head">头像</button>
                                    <button class="btn btn-default btn-com" type="button" data-type="nickname">昵称</button>
                                    <button class="btn btn-default btn-com" type="button" data-type="qr">二维码</button>
                                    <button class="btn btn-default btn-com" type="button" data-type="img">图片</button>
                                    <span id="goodsparams" style="display:none">
                                          <br>
                                        <button class="btn btn-default btn-com" type="button" data-type="title">商品名称</button>    
                                        <button class="btn btn-default btn-com" type="button" data-type="thumb">商品图片</button>    
                                        <button class="btn btn-default btn-com" type="button" data-type="marketprice">商品现价</button>    
                                        <button class="btn btn-default btn-com" type="button" data-type="productprice">商品原价</button>    
                                    </span>
                                </div>
                            </div>
							
							
							
                        </div>
                    </div>
                                    </td>
            </tr>
        </tbody></table>
		
		
        </div>
		 <input type="hidden" name="data" value="" />



        <div class="smtQr"><input type="submit" value="确认保存" class="smtQrIpt" /></div>
    </div>
</form>
 <script language='javascript'> 
     
	 $('form').submit(function(){
     
        var data = [];
        $('.drag').each(function(){
            var obj = $(this);
            var type = obj.attr('type');
            var left = obj.css('left'),top = obj.css('top');
            var d= {left:left,top:top,type:obj.attr('type'),width:obj.css('width'),height:obj.css('height')};
            if(type=='nickname' ||type=='title' || type=='marketprice' || type=='productprice'){
                d.size = obj.attr('size');
                d.color = obj.attr('color');
            } else if(type=='qr'){
                d.size = obj.attr('size');
            } else if(type=='img'){
                d.src = obj.attr('src');
            }
            data.push(d);
        });
        $(':input[name=data]').val( JSON.stringify(data));
        $('form').removeAttr('stop');
        return true;
    });
        
        function bindEvents(obj){
            
              var index = obj.attr('index');
            var rs = new Resize(obj, { Max: true, mxContainer: "#poster" });
            rs.Set($(".rRightDown",obj), "right-down");
            rs.Set($(".rLeftDown",obj), "left-down");
            rs.Set($(".rRightUp",obj), "right-up");
            rs.Set($(".rLeftUp",obj), "left-up");
            rs.Set($(".rRight",obj), "right");
            rs.Set($(".rLeft",obj), "left");
            rs.Set($(".rUp",obj), "up");
            rs.Set($(".rDown",obj), "down"); 
            rs.Scale = true;
            var type = obj.attr('type');
            if(type=='nickname' || type=='img' || type=='title' || type=='marketprice' || type=='productprice'){
                rs.Scale = false;
            }
            new Drag(obj, { Limit: true, mxContainer: "#poster" });
            $('.drag .remove').unbind('click').click(function(){
                $(this).parent().remove();
            })
			/*
         myrequire(['jquery.contextMenu'],function(){
		 
            $.contextMenu({
                 selector: '.drag[index=' + index + ']',
                 callback: function(key, options) {
                     var index = parseInt($(this).attr('zindex'));

                     if(key=='next'){
                         var nextdiv = $(this).next('.drag');
                         if(nextdiv.length>0 ){
                            nextdiv.insertBefore($(this));  
                         }
                     } else if(key=='prev'){
                         var prevdiv = $(this).prev('.drag');
                         if(prevdiv.length>0 ){
                            $(this).insertBefore(prevdiv);  
                         } 
                     } else if(key=='last'){
                         var len = $('.drag').length;
                          if(index >=len-1){
                             return;
                         } 
                         var last = $('#poster .drag:last');
                         if(last.length>0){
                            $(this).insertAfter(last);  
                         }
                     }else if(key=='first'){
                         var index = $(this).index();
                         if(index<=1){
                             return;
                         }
                         var first = $('#poster .drag:first');
                         if(first.length>0){
                            $(this).insertBefore(first);  
                         }
                     }else if(key=='delete'){
                        $(this).remove();
                     }
                     var n =1 ;
                     $('.drag').each(function(){
                         $(this).css("z-index",n);
                         n++; 
                     })
                 },
                 items: {
                     "next": {name: "调整到上层"},
                     "prev": {name: "调整到下层"},
                     "last": {name: "调整到最顶层"},
                     "first": {name: "调整到最低层"},
                     "delete": {name: "删除元素"}
                 }
             });
             obj.unbind('click').click(function(){
                 bind($(this));
             })
            });
			*/
              
              
        }
		
   var imgsettimer = 0 ;
   var nametimer = 0;
   var bgtimer = 0 ;
         function bindType(type){
             $("#goodsparams").hide();
             $(".type4").hide();
             if(type=='4'){
                 $(".type4").show();    
             } else if(type=='3'){
                    $("#goodsparams").show();
             }
         }
         function clearTimers(){
           clearInterval(imgsettimer);
           clearInterval(nametimer);
           clearInterval(bgtimer);
           
         }
         function getImgUrl(val){
       
              if(val.indexOf('http://')==-1){
                  val = "http://rrshop.cn/attachment/" + val;
              }
              return val;
         }
         function bind(obj){
            var imgset = $('#imgset'), nameset = $("#nameset"),qrset = $('#qrset');
             imgset.hide(),nameset.hide(),qrset.hide();
             clearTimers();
               var type = obj.attr('type');
               if(type=='img'){
                   imgset.show();
                   var src = obj.attr('src');
                   var input = imgset.find('input');
                   var img = imgset.find('img');
                   if(typeof(src)!='undefined' && src!=''){
                       input.val(src); 
                       img.attr('src',getImgUrl(src));
                  }
                   
                   imgsettimer = setInterval(function(){
                       if(input.val()!=src && input.val()!=''){
                           var url = getImgUrl(input.val());
                         
                           obj.attr('src',input.val()).find('img').attr('src',url);
                       }
                   },10);
                   
             } else if(type=='nickname' || type=='title' || type=='marketprice' || type=='productprice'){
       
                  nameset.show();
                  var color = obj.attr('color') || "#000";
                  var size = obj.attr('size') || "16";
                  var input = nameset.find('input:first');
                  var namesize = nameset.find('#namesize');
                  var picker = nameset.find('.sp-preview-inner');
                  input.val(color); namesize.val(size.replace("px",""));  
                  picker.css( {'background-color':color,'font-size':size});
                      
                  nametimer = setInterval(function(){
                       obj.attr('color',input.val()).find('.text').css('color',input.val());
                       obj.attr('size',namesize.val() +"px").find('.text').css('font-size',namesize.val() +"px");
                   },10);
                   
             } else if(type=='qr'){
                 qrset.show();
                 var size = obj.attr('size') || "3";
                 var sel = qrset.find('#qrsize');
                 sel.val(size);
                 sel.unbind('change').change(function(){
                      obj.attr('size',sel.val()) 
                 });
             }  
         }
         
    $(function(){ 
	
          $('.drag').each(function(){
              bindEvents($(this));
          }) 
                              
            $(':radio[name=type]').click(function(){
                var type = $(this).val();
                bindType(type);
            })

        $(':radio[name=resptype]').click(function(){
            var type = $(this).val();
            if(type == 1)
            {
                $(".resptype1").show();
                $(".resptype0").hide();
            }
            else
            {
                $(".resptype0").show();
                $(".resptype1").hide();
            }
        })
        //改变背景
        $('#bgset').find('button:first').click(function(){
            var oldbg = $(':input[name=bg]').val();
            bgtimer = setInterval(function(){
                 var bg = $(':input[name=bg]').val();
                 if(oldbg!=bg){
                 	  bg = getImgUrl(bg);
                       
                      $('#poster .bg').remove();
                      var bgh = $("<img src='" + bg + "' class='bg' />");
                       var first = $('#poster .drag:first');
                        if(first.length>0){
                           bgh.insertBefore(first);  
                        } else{
                           $('#poster').append(bgh);      
                        }
                       
                      oldbg = bg;
                 }
            },10);
        })
           
        $('.btn-com').click(function(){
            
           var imgset = $('#imgset'), nameset = $("#nameset"),qrset = $('#qrset');
           imgset.hide(),nameset.hide(),qrset.hide();
           clearTimers();
      
            if($('#poster img').length<=0){
                //alert('请选择背景图片!');
                //return;
            }
            var type = $(this).data('type');
            var img = "";
            if(type=='qr'){
                img = '<img src="/themes/default/Admin/statics/images/qr.jpg" />';
            }
            else if(type=='head'){
                img = '<img src="/themes/default/Admin/statics/images/head.jpg" />';
            }else  if(type=='img' || type=='thumb'){
                img = '<img src="/themes/default/Admin/statics/images/default-pic.jpg" />';
            }
            else if(type=='nickname'){
                img = '<div class=text>昵称</div>';
            }  else if(type=='title'){
                img = '<div class=text>商品名称</div>';
            } else if(type=='marketprice'){
                img = '<div class=text>商品现价</div>';
            }else if(type=='productprice'){
                img = '<div class=text>商品原价</div>';
            }
            var index = $('#poster .drag').length+1;
            var obj = $('<div class="drag" type="' + type +'" index="' + index +'" style="z-index:' + index+'">' + img+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');

            $('#poster').append(obj);
            
            bindEvents(obj);
            
        });
  
         $('.drag').click(function(){
               bind($(this))     ;
         })
        
    })
 



 /*
 
    $('form').submit(function(){
	
	    var data = [];
		
        $('.drag').each(function(){
            var obj = $(this);
            var type = obj.attr('type');
            var left = obj.css('left'),top = obj.css('top');
            var d= {left:left,top:top,type:obj.attr('type'),width:obj.css('width'),height:obj.css('height')};
            if(type=='nickname' ||type=='title' || type=='marketprice' || type=='productprice'){
                d.size = obj.attr('size');
                d.color = obj.attr('color');
            } else if(type=='qr'){
                d.size = obj.attr('size');
            } else if(type=='img'){
                d.src = obj.attr('src');
            }
            //data.push(d);
			data=d;
        });
		//alert(data);
        $(':input[name=data]').val( JSON.stringify(data));
        $('form').removeAttr('stop');
		
		
        return true;
		
		
	});
	
	 
		
        function bindEvents(obj){
            
              var index = obj.attr('index');
              
            var rs = new Resize(obj, { Max: true, mxContainer: "#poster" });
            rs.Set($(".rRightDown",obj), "right-down");
            rs.Set($(".rLeftDown",obj), "left-down");
            rs.Set($(".rRightUp",obj), "right-up");
            rs.Set($(".rLeftUp",obj), "left-up");
            rs.Set($(".rRight",obj), "right");
            rs.Set($(".rLeft",obj), "left");
            rs.Set($(".rUp",obj), "up");
            rs.Set($(".rDown",obj), "down"); 
            rs.Scale = true;
            var type = obj.attr('type');
            if(type=='nickname' || type=='img' || type=='title' || type=='marketprice' || type=='productprice'){
                rs.Scale = false;
            }
            new Drag(obj, { Limit: true, mxContainer: "#poster" });
            $('.drag .remove').unbind('click').click(function(){
                $(this).parent().remove();
            })
         myrequire(['jquery.contextMenu'],function(){
            $.contextMenu({
                 selector: '.drag[index=' + index + ']',
                 callback: function(key, options) {
                     var index = parseInt($(this).attr('zindex'));

                     if(key=='next'){
                         var nextdiv = $(this).next('.drag');
                         if(nextdiv.length>0 ){
                            nextdiv.insertBefore($(this));  
                         }
                     } else if(key=='prev'){
                         var prevdiv = $(this).prev('.drag');
                         if(prevdiv.length>0 ){
                            $(this).insertBefore(prevdiv);  
                         } 
                     } else if(key=='last'){
                         var len = $('.drag').length;
                          if(index >=len-1){
                             return;
                         } 
                         var last = $('#poster .drag:last');
                         if(last.length>0){
                            $(this).insertAfter(last);  
                         }
                     }else if(key=='first'){
                         var index = $(this).index();
                         if(index<=1){
                             return;
                         }
                         var first = $('#poster .drag:first');
                         if(first.length>0){
                            $(this).insertBefore(first);  
                         }
                     }else if(key=='delete'){
                        $(this).remove();
                     }
                     var n =1 ;
                     $('.drag').each(function(){
                         $(this).css("z-index",n);
                         n++; 
                     })
                 },
                 items: {
                     "next": {name: "调整到上层"},
                     "prev": {name: "调整到下层"},
                     "last": {name: "调整到最顶层"},
                     "first": {name: "调整到最低层"},
                     "delete": {name: "删除元素"}
                 }
             });
             obj.unbind('click').click(function(){
                 bind($(this));
             })
            });
              
              
        }
   var imgsettimer = 0 ;
   var nametimer = 0;
   var bgtimer = 0 ;
         function bindType(type){
             $("#goodsparams").hide();
             $(".type4").hide();
             if(type=='4'){
                 $(".type4").show();    
             } else if(type=='3'){
                    $("#goodsparams").show();
             }
         }
         function clearTimers(){
           clearInterval(imgsettimer);
           clearInterval(nametimer);
           clearInterval(bgtimer);
           
         }
         function getImgUrl(val){
       
              if(val.indexOf('http://')==-1){
                  val = "http://rrshop.cn/attachment/" + val;
              }
              return val;
         }
         function bind(obj){
            var imgset = $('#imgset'), nameset = $("#nameset"),qrset = $('#qrset');
             imgset.hide(),nameset.hide(),qrset.hide();
             clearTimers();
               var type = obj.attr('type');
               if(type=='img'){
                   imgset.show();
                   var src = obj.attr('src');
                   var input = imgset.find('input');
                   var img = imgset.find('img');
                   if(typeof(src)!='undefined' && src!=''){
                       input.val(src); 
                       img.attr('src',getImgUrl(src));
                  }
                   
                   imgsettimer = setInterval(function(){
                       if(input.val()!=src && input.val()!=''){
                           var url = getImgUrl(input.val());
                         
                           obj.attr('src',input.val()).find('img').attr('src',url);
                       }
                   },10);
                   
             } else if(type=='nickname' || type=='title' || type=='marketprice' || type=='productprice'){
       
                  nameset.show();
                  var color = obj.attr('color') || "#000";
                  var size = obj.attr('size') || "16";
                  var input = nameset.find('input:first');
                  var namesize = nameset.find('#namesize');
                  var picker = nameset.find('.sp-preview-inner');
                  input.val(color); namesize.val(size.replace("px",""));  
                  picker.css( {'background-color':color,'font-size':size});
                      
                  nametimer = setInterval(function(){
                       obj.attr('color',input.val()).find('.text').css('color',input.val());
                       obj.attr('size',namesize.val() +"px").find('.text').css('font-size',namesize.val() +"px");
                   },10);
                   
             } else if(type=='qr'){
                 qrset.show();
                 var size = obj.attr('size') || "3";
                 var sel = qrset.find('#qrsize');
                 sel.val(size);
                 sel.unbind('change').change(function(){
                      obj.attr('size',sel.val()) 
                 });
             }  
         }
         
         
 

 
 
    $(function(){
                         
          $('.drag').each(function(){ 
              bindEvents($(this));
          }) 
		//alert('data');
                              
            $(':radio[name=type]').click(function(){
                var type = $(this).val();
                bindType(type);
            })
 
        $(':radio[name=resptype]').click(function(){
            var type = $(this).val();
            if(type == 1)
            {
                $(".resptype1").show();
                $(".resptype0").hide();
            }
            else
            {
                $(".resptype0").show();
                $(".resptype1").hide();
            }
        })
        //改变背景
        $('#bgset').find('button:first').click(function(){
            var oldbg = $(':input[name=bg]').val();
            bgtimer = setInterval(function(){
                 var bg = $(':input[name=bg]').val();
                 if(oldbg!=bg){
                 	  bg = getImgUrl(bg);
                       
                      $('#poster .bg').remove();
                      var bgh = $("<img src='" + bg + "' class='bg' />");
                       var first = $('#poster .drag:first');
                        if(first.length>0){
                           bgh.insertBefore(first);  
                        } else{
                           $('#poster').append(bgh);      
                        }
                       
                      oldbg = bg;
                 }
            },10);
        })
           
        $('.btn-com').click(function(){
            
           var imgset = $('#imgset'), nameset = $("#nameset"),qrset = $('#qrset');
           imgset.hide(),nameset.hide(),qrset.hide();
           clearTimers();
      
            if($('#poster img').length<=0){
                //alert('请选择背景图片!');
                //return;
            }
            var type = $(this).data('type');
            var img = "";
            if(type=='qr'){
                img = '<img src="/themes/default/Admin/statics/images/nopic.jpg" />';
            }
            else if(type=='head'){
                img = '<img src="../addons/ewei_shopv2/plugin/poster/static/images/head.jpg" />';
            }else  if(type=='img' || type=='thumb'){
                img = '<img src="../addons/ewei_shopv2/plugin/poster/static/images/img.jpg" />';
            }
            else if(type=='nickname'){
                img = '<div class=text>昵称</div>';
            }  else if(type=='title'){
                img = '<div class=text>商品名称</div>';
            } else if(type=='marketprice'){
                img = '<div class=text>商品现价</div>';
            }else if(type=='productprice'){
                img = '<div class=text>商品原价</div>';
            }
            var index = $('#poster .drag').length+1;
            var obj = $('<div class="drag" type="' + type +'" index="' + index +'" style="z-index:' + index+'">' + img+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');
            
            $('#poster').append(obj);
            
            bindEvents(obj);
            
        });
  
         $('.drag').click(function(){
               bind($(this))     ;
         })
        
    })
	*/
 
	
    </script>


<include  file='public:footer'/>       